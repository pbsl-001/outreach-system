<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Business Outreach CRM System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active {
            color: #667eea;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-tab .badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.has-file {
            border-style: solid;
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-mismatch {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-new {
            background: #e2e3e5;
            color: #41464b;
        }

        .status-prospected {
            background: #cce5ff;
            color: #004085;
        }

        .status-contacted {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-engaged {
            background: #d4edda;
            color: #155724;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
            font-weight: 600;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .edit-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .duplicate-check-results {
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            background: #fffbf0;
        }

        .duplicate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .duplicate-item:last-child {
            border-bottom: none;
        }

        .company-search {
            margin-bottom: 20px;
        }

        .company-search input {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            width: 100%;
        }

        .company-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }

        .company-card:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .company-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .company-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .last-contact {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UK Business Outreach CRM</h1>
            <p>Streamline your PSC verification, relationship management, and letter generation</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('upload')">
                📤 Upload & Import
            </button>
            <button class="nav-tab" onclick="switchTab('companies')">
                🏢 Companies Database
                <span class="badge" id="companiesBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('verify')">
                ✓ Verify PSC Data
                <span class="badge" id="verifyBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('merge')">
                📝 Mail Generation
                <span class="badge" id="mergeBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('print')">
                🖨️ Print Queue
                <span class="badge" id="printBadge" style="display: none;">0</span>
            </button>
        </div>

        <div class="content">
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content active">
                <div class="upload-section" id="uploadSection">
                    <h3>📁 Upload Excel Spreadsheet</h3>
                    <p style="margin: 15px 0; color: #6c757d;">Upload your data from unique-sector-performance-data.co.uk</p>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                    <div id="fileInfo" style="margin-top: 20px; display: none;">
                        <p style="color: #28a745; font-weight: 600;">✓ File loaded successfully</p>
                        <p id="fileName" style="color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>

                <div id="dataPreview" style="display: none;">
                    <h3 style="margin-bottom: 20px;">📊 Data Preview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">0</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uniqueCompanies">0</div>
                            <div class="stat-label">Unique Companies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="newCompanies">0</div>
                            <div class="stat-label">New Companies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="duplicateCompanies">0</div>
                            <div class="stat-label">Already in Database</div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="dataTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addToCRMDatabase()">
                            Add New Companies to Database
                        </button>
                        <button class="btn btn-secondary" onclick="proceedToVerification()">
                            Proceed to Verification →
                        </button>
                    </div>
                </div>

                <!-- Sample Data Section -->
                <div id="sampleDataSection" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">🎯 Or Use Sample Data</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">Load sample data to test the system</p>
                    <button class="btn btn-primary" onclick="loadSampleData()">
                        Load Sample Data
                    </button>
                </div>
            </div>

            <!-- Companies Database Tab -->
            <div id="companiesTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🏢 Companies Database</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCompaniesInDB">0</div>
                        <div class="stat-label">Total Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesContacted">0</div>
                        <div class="stat-label">Companies Contacted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesEngaged">0</div>
                        <div class="stat-label">Engaged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesDoNotContact">0</div>
                        <div class="stat-label">Do Not Contact</div>
                    </div>
                </div>

                <div class="company-search">
                    <input type="text" id="companySearchInput" placeholder="Search companies by name, number, or PSC name..." onkeyup="searchCompanies()">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addManualCompany()">
                        + Add Manual Entry
                    </button>
                    <button class="btn btn-secondary" onclick="exportCRMData()">
                        Export Database
                    </button>
                </div>

                <div id="companiesList" style="margin-top: 30px;">
                    <!-- Companies will be displayed here -->
                </div>
            </div>

            <!-- Verify Tab (mostly unchanged) -->
            <div id="verifyTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🔍 PSC Verification Against Companies House</h3>
                <div id="verificationContent">
                    <p style="color: #6c757d; margin: 20px 0;">Upload data first to begin verification process.</p>
                </div>
            </div>

            <!-- Mail Generation Tab (Enhanced with duplicate checking) -->
            <div id="mergeTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">📮 Mail Generation with Duplicate Protection</h3>
                
                <div id="mergeContent">
                    <p style="color: #6c757d; margin: 20px 0;">Loading...</p>
                </div>

                <div id="duplicateCheckResults" style="display: none;">
                    <!-- Duplicate check results will appear here -->
                </div>

                <div id="lettersList" style="display: none;">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateLettersAfterCheck()">
                            Generate Letters for Eligible Companies
                        </button>
                        <button class="btn btn-secondary" onclick="previewTemplate()">
                            Preview Template
                        </button>
                    </div>
                    <div id="generatedLetters" style="margin-top: 30px;"></div>
                </div>
            </div>

            <!-- Print Tab -->
            <div id="printTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🖨️ Print Queue Management</h3>
                <div id="printContent">
                    <p style="color: #6c757d; margin: 20px 0;">No letters ready for printing.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Edit Record</h3>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="modalSaveBtn" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PHASE 1: CORE CRM INTEGRATION
        // ============================================

        // Global data storage - ENHANCED FOR CRM
        let companiesDatabase = {}; // Main CRM database
        let uploadedData = [];      // Current upload session
        let verifiedData = [];      // Verified records
        let lettersGenerated = [];  // Generated letters
        let currentEditIndex = -1;
        let currentModalType = 'edit'; // 'edit' or 'add'

        // ============================================
        // CRM DATABASE FUNCTIONS
        // ============================================
        
        function initializeCRMDatabase() {
            loadCRMData();
            updateDashboardStats();
            displayCompanies();
        }

        function saveCRMData() {
            try {
                localStorage.setItem('ukBusinessCRM', JSON.stringify(companiesDatabase));
                console.log('CRM data saved successfully');
            } catch (error) {
                console.error('Failed to save CRM data:', error);
                alert('Warning: Failed to save data to browser storage');
            }
        }

        function loadCRMData() {
            try {
                const saved = localStorage.getItem('ukBusinessCRM');
                if (saved) {
                    companiesDatabase = JSON.parse(saved);
                    console.log(`Loaded ${Object.keys(companiesDatabase).length} companies from storage`);
                    return true;
                }
            } catch (error) {
                console.error('Failed to load CRM data:', error);
            }
            return false;
        }

        function addCompanyToCRM(recordData) {
            const companyNumber = recordData.companyNumber;
            
            // Check if company already exists
            if (companiesDatabase[companyNumber]) {
                console.log('Company already exists in CRM:', companyNumber);
                return false;
            }

            // Create company record
            companiesDatabase[companyNumber] = {
                // Basic company info
                companyNumber: companyNumber,
                companyName: recordData.companyName,
                industry: recordData.industry || '',
                turnover: recordData.turnover || '',
                website: recordData.website || '',
                
                // Primary PSC contact
                primaryPSC: {
                    pscTitle: recordData.pscTitle,
                    pscFirstName: recordData.pscFirstName,
                    pscLastName: recordData.pscLastName,
                    pscFullName: recordData.pscFullName,
                    addressLine1: recordData.addressLine1,
                    addressLine2: recordData.addressLine2,
                    city: recordData.city,
                    county: recordData.county,
                    postcode: recordData.postcode
                },
                
                // Other contacts (CFO, etc.)
                otherContacts: [],
                
                // Communication history
                communications: [],
                
                // Status and tracking
                status: 'new', // new -> prospected -> contacted -> engaged -> qualified -> active
                reference: recordData.reference,
                addedDate: new Date().toISOString().split('T')[0],
                lastMailDate: null,
                lastContactDate: null,
                nextAction: null,
                doNotContact: false,
                
                // Intelligence and notes
                intelligence: {
                    businessNotes: '',
                    acquisitionTriggers: '',
                    lastResearched: null,
                    recentNews: []
                }
            };
            
            saveCRMData();
            return true;
        }

        function updateCompanyStatus(companyNumber, newStatus) {
            if (companiesDatabase[companyNumber]) {
                companiesDatabase[companyNumber].status = newStatus;
                saveCRMData();
            }
        }

        function checkContactHistory(companyNumber) {
            const company = companiesDatabase[companyNumber];
            if (!company) return { canContact: true, reason: 'new_company' };
            
            // Check do not contact flag
            if (company.doNotContact) {
                return { canContact: false, reason: 'do_not_contact' };
            }
            
            // Check last letter date
            if (company.lastMailDate) {
                const daysSinceLastLetter = Math.floor(
                    (new Date() - new Date(company.lastMailDate)) / (1000 * 60 * 60 * 24)
                );
                
                if (daysSinceLastLetter < 365) {
                    return { 
                        canContact: false, 
                        reason: 'recent_contact',
                        lastContactDate: company.lastMailDate,
                        daysSince: daysSinceLastLetter
                    };
                }
            }
            
            return { canContact: true, reason: 'eligible' };
        }

        function addCommunicationRecord(companyNumber, communicationData) {
            if (!companiesDatabase[companyNumber]) {
                console.error('Company not found:', companyNumber);
                return false;
            }
            
            const communication = {
                id: `comm_${Date.now()}`,
                date: communicationData.date || new Date().toISOString().split('T')[0],
                type: communicationData.type,
                subject: communicationData.subject || '',
                notes: communicationData.notes || '',
                response: communicationData.response || null,
                responseDate: communicationData.responseDate || null
            };
            
            companiesDatabase[companyNumber].communications.push(communication);
            
            // Update status based on communication type
            if (communication.type === 'letter' && companiesDatabase[companyNumber].status === 'new') {
                companiesDatabase[companyNumber].status = 'prospected';
                companiesDatabase[companyNumber].lastMailDate = communication.date;
                companiesDatabase[companyNumber].lastContactDate = communication.date;
            }
            
            saveCRMData();
            return communication.id;
        }

        // ============================================
        // ENHANCED UPLOAD PROCESSING
        // ============================================
        
        function processUploadedData(data) {
            uploadedData = data.map((row, index) => ({
                id: index + 1,
                companyName: row['Company Name'] || row['company_name'] || '',
                companyNumber: row['Company Number'] || row['company_number'] || '',
                pscTitle: row['PSC Title'] || row['Title'] || 'Mr',
                pscFirstName: row['PSC First Name'] || row['PSC_First_Name'] || '',
                pscLastName: row['PSC Last Name'] || row['PSC_Last_Name'] || '',
                pscFullName: ((row['PSC First Name'] || '') + ' ' + (row['PSC Last Name'] || '')).trim(),
                addressLine1: row['PSC Address1'] || row['Address Line 1'] || '',
                addressLine2: row['PSC Address2'] || row['Address Line 2'] || '',
                city: row['PSC Address3'] || row['City'] || '',
                county: row['PSC Address4'] || row['County'] || '',
                postcode: row['PSC Postcode'] || row['Postcode'] || '',
                reference: row['Reference'] || row['reference'] || generateReference(),
                industry: row['Industry'] || '',
                turnover: row['Turnover'] || '',
                status: 'pending',
                selected: false,
                // CRM Status indicators
                inDatabase: companiesDatabase[row['Company Number']] ? true : false,
                lastContact: companiesDatabase[row['Company Number']] ? companiesDatabase[row['Company Number']].lastMailDate : null
            }));

            displayUploadedData();
            updateUploadStats();
            updateMailMergeTab();
        }

        function displayUploadedData() {
            const table = document.getElementById('dataTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th><input type="checkbox" onchange="selectAll(this)"></th>
                <th>Company Name</th>
                <th>Company Number</th>
                <th>PSC Name</th>
                <th>Address</th>
                <th>CRM Status</th>
                <th>Last Contact</th>
                <th>Actions</th>
            `;
            thead.appendChild(headerRow);
            
            uploadedData.forEach((record, index) => {
                const row = document.createElement('tr');
                const address = `${record.addressLine1}, ${record.city}, ${record.postcode}`;
                
                // CRM status
                let crmStatus = 'New';
                let statusClass = 'status-new';
                if (record.inDatabase) {
                    const company = companiesDatabase[record.companyNumber];
                    crmStatus = company.status;
                    statusClass = `status-${company.status}`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" ${record.selected ? 'checked' : ''} onchange="toggleSelection(${index})"></td>
                    <td>${record.companyName}</td>
                    <td>${record.companyNumber}</td>
                    <td>${record.pscTitle} ${record.pscFullName}</td>
                    <td>${address}</td>
                    <td><span class="status-badge ${statusClass}">${crmStatus}</span></td>
                    <td>${record.lastContact || 'Never'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editRecord(${index})" style="padding: 5px 10px; font-size: 0.85rem;">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('dataPreview').style.display = 'block';
        }

        function updateUploadStats() {
            const newCompanies = uploadedData.filter(r => !r.inDatabase).length;
            const duplicateCompanies = uploadedData.filter(r => r.inDatabase).length;
            
            document.getElementById('totalRecords').textContent = uploadedData.length;
            document.getElementById('uniqueCompanies').textContent = 
                new Set(uploadedData.map(r => r.companyNumber)).size;
            document.getElementById('newCompanies').textContent = newCompanies;
            document.getElementById('duplicateCompanies').textContent = duplicateCompanies;
        }

        function addToCRMDatabase() {
            const newCompanies = uploadedData.filter(r => !r.inDatabase);
            
            if (newCompanies.length === 0) {
                alert('No new companies to add - all are already in the database');
                return;
            }
            
            let addedCount = 0;
            newCompanies.forEach(record => {
                if (addCompanyToCRM(record)) {
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                alert(`Successfully added ${addedCount} new companies to the database`);
                updateDashboardStats();
                displayCompanies();
                
                // Refresh the upload view to show updated status
                processUploadedData(uploadedData.map(r => ({
                    'Company Name': r.companyName,
                    'Company Number': r.companyNumber,
                    'PSC Title': r.pscTitle,
                    'PSC First Name': r.pscFirstName,
                    'PSC Last Name': r.pscLastName,
                    'PSC Address1': r.addressLine1,
                    'PSC Address2': r.addressLine2,
                    'PSC Address3': r.city,
                    'PSC Address4': r.county,
                    'PSC Postcode': r.postcode,
                    'Reference': r.reference,
                    'Industry': r.industry,
                    'Turnover': r.turnover
                })));
            }
        }

        // ============================================
        // COMPANIES DATABASE DISPLAY
        // ============================================
        
        function displayCompanies(searchTerm = '') {
            const companiesList = document.getElementById('companiesList');
            const companies = Object.values(companiesDatabase);
            
            let filteredCompanies = companies;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredCompanies = companies.filter(company => 
                    company.companyName.toLowerCase().includes(term) ||
                    company.companyNumber.toLowerCase().includes(term) ||
                    company.primaryPSC.pscFullName.toLowerCase().includes(term)
                );
            }
            
            if (filteredCompanies.length === 0) {
                companiesList.innerHTML = searchTerm ? 
                    '<p>No companies found matching your search.</p>' :
                    '<p>No companies in database yet. Upload data to get started.</p>';
                return;
            }
            
            companiesList.innerHTML = filteredCompanies
                .sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate))
                .map(company => `
                    <div class="company-card">
                        <div class="company-header">
                            <div>
                                <div class="company-title">${company.companyName}</div>
                                <div class="company-subtitle">${company.companyNumber} | ${company.primaryPSC.pscFullName}</div>
                            </div>
                            <div>
                                <span class="status-badge status-${company.status}">${company.status}</span>
                            </div>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <strong>Address:</strong> ${company.primaryPSC.addressLine1}, ${company.primaryPSC.city}, ${company.primaryPSC.postcode}<br>
                            ${company.website ? `<strong>Website:</strong> <a href="${company.website}" target="_blank">${company.website}</a><br>` : ''}
                            <strong>Reference:</strong> ${company.reference}
                        </div>
                        
                        <div class="last-contact">
                            Last Contact: ${company.lastContactDate || 'Never'} | 
                            Communications: ${company.communications.length} | 
                            Added: ${company.addedDate}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="viewCompanyDetails('${company.companyNumber}')">
                                View Details
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editCompanyRecord('${company.companyNumber}')">
                                Edit
                            </button>
                            ${!company.doNotContact && (!company.lastMailDate || daysSinceContact(company.lastMailDate) > 365) ? `
                                <button class="btn btn-sm btn-success" onclick="generateSingleLetter('${company.companyNumber}')">
                                    Send Letter
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
        }

        function searchCompanies() {
            const searchTerm = document.getElementById('companySearchInput').value;
            displayCompanies(searchTerm);
        }

        function updateDashboardStats() {
            const companies = Object.values(companiesDatabase);
            const total = companies.length;
            const contacted = companies.filter(c => c.status === 'prospected' || c.status === 'contacted' || c.status === 'engaged').length;
            const engaged = companies.filter(c => c.status === 'engaged').length;
            const doNotContact = companies.filter(c => c.doNotContact).length;
            
            document.getElementById('totalCompaniesInDB').textContent = total;
            document.getElementById('companiesContacted').textContent = contacted;
            document.getElementById('companiesEngaged').textContent = engaged;
            document.getElementById('companiesDoNotContact').textContent = doNotContact;
            
            updateBadge('companiesBadge', total);
        }

        function daysSinceContact(dateString) {
            if (!dateString) return 999;
            return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
        }

        // ============================================
        // ENHANCED MAIL MERGE WITH DUPLICATE CHECK
        // ============================================
        
        function updateMailMergeTab() {
            const companies = Object.values(companiesDatabase);
            const eligibleCount = companies.filter(c => {
                const check = checkContactHistory(c.companyNumber);
                return check.canContact;
            }).length;
            
            const recentContactCount = companies.filter(c => {
                const check = checkContactHistory(c.companyNumber);
                return !check.canContact && check.reason === 'recent_contact';
            }).length;
            
            const mergeContent = document.getElementById('mergeContent');
            
            if (companies.length === 0) {
                mergeContent.innerHTML = '<p style="color: #6c757d; margin: 20px 0;">No companies in database. Please upload data first.</p>';
                return;
            }
            
            mergeContent.innerHTML = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${companies.length}</div>
                        <div class="stat-label">Total Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${eligibleCount}</div>
                        <div class="stat-label">Eligible for Contact</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${recentContactCount}</div>
                        <div class="stat-label">Recently Contacted</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="runDuplicateCheck()">
                        Check Eligible Companies
                    </button>
                </div>
            `;
        }

        function runDuplicateCheck() {
            const companies = Object.values(companiesDatabase);
            const eligibleRecords = [];
            const blockedRecords = [];
            
            companies.forEach(company => {
                const check = checkContactHistory(company.companyNumber);
                
                if (check.canContact) {
                    eligibleRecords.push(company);
                } else {
                    blockedRecords.push({
                        ...company,
                        blockReason: check.reason,
                        lastContact: check.lastContactDate,
                        daysSince: check.daysSince
                    });
                }
            });
            
            displayDuplicateCheckResults(eligibleRecords, blockedRecords);
        }

        function displayDuplicateCheckResults(eligible, blocked) {
            const resultsDiv = document.getElementById('duplicateCheckResults');
            resultsDiv.style.display = 'block';
            
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h4>✅ Ready to Contact: ${eligible.length} companies</h4>
                    <p>These companies haven't been contacted in the last 12 months and are eligible for letters.</p>
                </div>
                
                ${blocked.length > 0 ? `
                    <div class="alert alert-warning">
                        <h4>⚠️ Recently Contacted: ${blocked.length} companies</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>PSC</th>
                                        <th>Last Contact</th>
                                        <th>Days Ago</th>
                                        <th>Reason</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${blocked.map(company => `
                                        <tr>
                                            <td>${company.companyName}</td>
                                            <td>${company.primaryPSC.pscFullName}</td>
                                            <td>${company.lastContact || 'N/A'}</td>
                                            <td>${company.daysSince || 'N/A'}</td>
                                            <td>${company.blockReason === 'recent_contact' ? 'Too Recent' : 'Do Not Contact'}</td>
                                            <td>
                                                ${company.blockReason === 'recent_contact' ? `
                                                    <button onclick="overrideContactBlock('${company.companyNumber}')" 
                                                            class="btn btn-sm btn-warning">Override</button>
                                                ` : 'Blocked'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${eligible.length > 0 ? `
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="generateLettersForEligible()">
                            Generate ${eligible.length} Letters
                        </button>
                        <button class="btn btn-secondary" onclick="previewTemplate()">
                            Preview Template
                        </button>
                    </div>
                ` : ''}
            `;
            
            // Store eligible companies for letter generation
            window.eligibleCompanies = eligible;
        }

        function generateLettersForEligible() {
            if (!window.eligibleCompanies || window.eligibleCompanies.length === 0) {
                alert('No eligible companies found. Run duplicate check first.');
                return;
            }
            
            lettersGenerated = window.eligibleCompanies.map(company => {
                // Log letter being sent
                addCommunicationRecord(company.companyNumber, {
                    type: 'letter',
                    subject: 'Initial Acquisition Inquiry',
                    notes: 'Template: standard_acquisition'
                });
                
                return {
                    ...company,
                    letterContent: generateLetterContent(company),
                    envelopeContent: generateEnvelopeContent(company)
                };
            });
            
            displayGeneratedLetters();
            updateBadge('printBadge', lettersGenerated.length);
            updateDashboardStats(); // Update stats to reflect new contact status
            
            alert(`Generated ${lettersGenerated.length} letters successfully! Communication records have been logged.`);
        }

        function generateLetterContent(company) {
            const today = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            const psc = company.primaryPSC;
            
            return `
                <div class="letter-preview">
                    <div class="letter-header">[STRICTLY PRIVATE AND CONFIDENTIAL]</div>
                    <div style="text-align: right;">London Office</div>
                    
                    <div class="letter-address">
                        ${psc.pscTitle} ${psc.pscFirstName} ${psc.pscLastName}<br>
                        ${psc.addressLine1}<br>
                        ${psc.addressLine2 ? psc.addressLine2 + '<br>' : ''}
                        ${psc.city}<br>
                        ${psc.county ? psc.county + '<br>' : ''}
                        ${psc.postcode}
                    </div>
                    
                    <div class="letter-date">${today}</div>
                    
                    <div>Dear ${psc.pscTitle} ${psc.pscLastName},</div>
                    
                    <div style="margin: 20px 0;">
                        <strong>Ref: ${company.reference}</strong>
                    </div>
                    
                    <div class="letter-body">
                        <p>I am writing to you on a confidential basis following specific acquisition research work we have recently carried out.</p>
                        
                        <p>It would appear that ${company.companyName} falls within the acquisition brief of a particular acquirer client of ours, thus I am writing to establish if you are interested in having an initial discussion regarding the possible sale of your business.</p>
                        
                        <p>As corporate intermediaries established for more than 40 years, we carry out acquisition work for our public and private company and private equity acquirer clients who have funds totalling more than £5bn to acquire businesses on a strictly private and confidential basis. We are a discreet firm and do not advertise to the public.</p>
                        
                        <p>The fees for our services are paid by our client, the acquirer, and we would make no charge to you, the vendor. We usually deal with vendor businesses which have not formally announced they are for sale, are not being actively marketed for sale and are seeking a discreet sale.</p>
                        
                        <p>If you are interested in such a possibility, I should welcome the opportunity of having an exploratory discussion with you at a time that suits you. I can assure you that the matter would be dealt with on a strictly confidential basis and would receive my immediate attention.</p>
                        
                        <p>I hope to hear from you at an early date and can be contacted directly on 0203 633 4829 or by email at: rudi@mgbco.co.uk.</p>
                    </div>
                    
                    <div class="letter-signature">
                        <p>Yours sincerely,</p>
                        <br>
                        <br>
                        <p>Rudi Prenzlin</p>
                        <p><u>Acquisitions Specialist</u></p>
                    </div>
                </div>
            `;
        }

        function generateEnvelopeContent(company) {
            const psc = company.primaryPSC;
            
            return `
                <div class="envelope-preview">
                    <div class="envelope-address">
                        ${psc.pscTitle} ${psc.pscFirstName} ${psc.pscLastName}<br>
                        ${psc.addressLine1}<br>
                        ${psc.addressLine2 ? psc.addressLine2 + '<br>' : ''}
                        ${psc.city}<br>
                        ${psc.county ? psc.county + '<br>' : ''}
                        ${psc.postcode}
                    </div>
                </div>
            `;
        }

        // ============================================
        // UTILITY FUNCTIONS (ENHANCED)
        // ============================================
        
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabs = ['upload', 'companies', 'verify', 'merge', 'print'];
            const tabIndex = tabs.indexOf(tabName);
            document.querySelectorAll('.nav-tab')[tabIndex].classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update tab content when switching
            if (tabName === 'companies') {
                updateDashboardStats();
                displayCompanies();
            } else if (tabName === 'merge') {
                updateMailMergeTab();
            }
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (count > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }

        function generateReference() {
            const prefix = 'HD';
            const number = Math.floor(100000 + Math.random() * 900000);
            return `${prefix}/${number}`;
        }

        // ============================================
        // FILE UPLOAD HANDLER (UNCHANGED)
        // ============================================
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        processUploadedData(jsonData);
                        
                        document.getElementById('uploadSection').classList.add('has-file');
                        document.getElementById('fileInfo').style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('sampleDataSection').style.display = 'none';
                    } catch (error) {
                        alert('Error reading file. Please ensure it\'s a valid Excel file.');
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // ============================================
        // SAMPLE DATA (UPDATED)
        // ============================================
        function loadSampleData() {
            const sampleData = [
                {
                    'Company Name': 'Davies Crane Hire Holdings Limited',
                    'Company Number': '08234567',
                    'PSC Title': 'Mr',
                    'PSC First Name': 'Malcolm',
                    'PSC Last Name': 'Davies',
                    'PSC Address1': 'Pensarn Works',
                    'PSC Address2': 'Pensarn',
                    'PSC Address3': 'Carmarthen',
                    'PSC Address4': 'Dyfed',
                    'PSC Postcode': 'SA31 2NG',
                    'Reference': 'HD/150902',
                    'Industry': 'Construction',
                    'Turnover': '£25m'
                },
                {
                    'Company Name': 'Smith Engineering Services Ltd',
                    'Company Number': '09876543',
                    'PSC Title': 'Mr',
                    'PSC First Name': 'James',
                    'PSC Last Name': 'Smith',
                    'PSC Address1': '45 Industrial Estate',
                    'PSC Address2': 'Westfield Road',
                    'PSC Address3': 'Birmingham',
                    'PSC Address4': 'West Midlands',
                    'PSC Postcode': 'B15 3TH',
                    'Reference': 'HD/150903',
                    'Industry': 'Engineering',
                    'Turnover': '£15m'
                },
                {
                    'Company Name': 'Thompson Manufacturing Group',
                    'Company Number': '07654321',
                    'PSC Title': 'Ms',
                    'PSC First Name': 'Sarah',
                    'PSC Last Name': 'Thompson',
                    'PSC Address1': 'Unit 12, Valley Business Park',
                    'PSC Address2': '',
                    'PSC Address3': 'Leeds',
                    'PSC Address4': 'West Yorkshire',
                    'PSC Postcode': 'LS12 5BH',
                    'Reference': 'HD/150904',
                    'Industry': 'Manufacturing',
                    'Turnover': '£40m'
                }
            ];

            processUploadedData(sampleData);
            
            document.getElementById('uploadSection').classList.add('has-file');
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = 'Sample Data (3 records)';
            document.getElementById('sampleDataSection').style.display = 'none';
        }

        // ============================================
        // REMAINING FUNCTIONS (Stubs for now)
        // ============================================
        
        // These will be implemented in Phase 2 & 3
        function selectAll(checkbox) {
            uploadedData.forEach(record => record.selected = checkbox.checked);
            displayUploadedData();
        }

        function toggleSelection(index) {
            uploadedData[index].selected = !uploadedData[index].selected;
        }

        function editRecord(index) {
            alert('Edit functionality will be enhanced in Phase 2');
        }

        function proceedToVerification() {
            switchTab('verify');
            alert('Verification functionality unchanged - will be enhanced in Phase 2');
        }

        function addManualCompany() {
            alert('Manual company entry will be implemented in Phase 2');
        }

        function exportCRMData() {
            const companies = Object.values(companiesDatabase);
            if (companies.length === 0) {
                alert('No data to export');
                return;
            }
            
            const exportData = companies.map(company => ({
                'Company Name': company.companyName,
                'Company Number': company.companyNumber,
                'PSC Title': company.primaryPSC.pscTitle,
                'PSC First Name': company.primaryPSC.pscFirstName,
                'PSC Last Name': company.primaryPSC.pscLastName,
                'Address Line 1': company.primaryPSC.addressLine1,
                'Address Line 2': company.primaryPSC.addressLine2,
                'City': company.primaryPSC.city,
                'County': company.primaryPSC.county,
                'Postcode': company.primaryPSC.postcode,
                'Status': company.status,
                'Reference': company.reference,
                'Added Date': company.addedDate,
                'Last Mail Date': company.lastMailDate || '',
                'Communications Count': company.communications.length,
                'Do Not Contact': company.doNotContact ? 'Yes' : 'No'
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'CRM Database');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `crm_database_${date}.xlsx`);
        }

        function viewCompanyDetails(companyNumber) {
            alert(`Company details view will be implemented in Phase 2`);
        }

        function editCompanyRecord(companyNumber) {
            alert(`Company edit functionality will be implemented in Phase 2`);
        }

        function generateSingleLetter(companyNumber) {
            alert(`Single letter generation will be implemented in Phase 2`);
        }

        function overrideContactBlock(companyNumber) {
            alert(`Contact override functionality will be implemented in Phase 2`);
        }

        function previewTemplate() {
            alert('Template preview functionality unchanged from original');
        }

        function displayGeneratedLetters() {
            alert('Letter display functionality unchanged from original');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            console.log('UK Business Outreach CRM System - Phase 1 loaded');
            initializeCRMDatabase();
        });
    </script>
</body>
</html>
