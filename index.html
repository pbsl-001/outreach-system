<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Business Outreach CRM System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active {
            color: #667eea;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-tab .badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.has-file {
            border-style: solid;
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
        }

        .status-mismatch {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-new {
            background: #e2e3e5;
            color: #41464b;
        }

        .status-prospected {
            background: #cce5ff;
            color: #004085;
        }

        .status-contacted {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-engaged {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
            font-weight: 600;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .edit-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .duplicate-check-results {
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            background: #fffbf0;
        }

        .company-search {
            margin-bottom: 20px;
        }

        .company-search input {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            width: 100%;
        }

        .company-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }

        .company-card:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .company-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .company-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .last-contact {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .api-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 100;
            cursor: pointer;
        }

        .api-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .api-status.demo {
            background: #fff3cd;
            color: #856404;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .verification-result {
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .verification-result.verified {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .verification-result.mismatch {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .verification-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UK Business Outreach CRM</h1>
            <p>Complete PSC verification, relationship management, and letter generation</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('upload')">
                📤 Upload & Import
            </button>
            <button class="nav-tab" onclick="switchTab('companies')">
                🏢 Companies Database
                <span class="badge" id="companiesBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('verify')">
                ✓ Verify PSC Data
                <span class="badge" id="verifyBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('merge')">
                📝 Mail Generation
                <span class="badge" id="mergeBadge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('print')">
                🖨️ Print Queue
                <span class="badge" id="printBadge" style="display: none;">0</span>
            </button>
        </div>

        <div class="content">
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content active">
                <div class="upload-section" id="uploadSection">
                    <h3>📁 Upload Excel Spreadsheet</h3>
                    <p style="margin: 15px 0; color: #6c757d;">Upload your data from unique-sector-performance-data.co.uk</p>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                    <div id="fileInfo" style="margin-top: 20px; display: none;">
                        <p style="color: #28a745; font-weight: 600;">✓ File loaded successfully</p>
                        <p id="fileName" style="color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>

                <div id="dataPreview" style="display: none;">
                    <h3 style="margin-bottom: 20px;">📊 Data Preview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">0</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uniqueCompanies">0</div>
                            <div class="stat-label">Unique Companies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="newCompanies">0</div>
                            <div class="stat-label">New Companies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="duplicateCompanies">0</div>
                            <div class="stat-label">Already in Database</div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="dataTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addToCRMDatabase()">
                            Add New Companies to Database
                        </button>
                        <button class="btn btn-secondary" onclick="proceedToVerification()">
                            Proceed to Verification →
                        </button>
                    </div>
                </div>

                <!-- Sample Data Section -->
                <div id="sampleDataSection" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">🎯 Or Use Sample Data</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">Load sample data to test the system</p>
                    <button class="btn btn-primary" onclick="loadSampleData()">
                        Load Sample Data
                    </button>
                </div>
            </div>

            <!-- Companies Database Tab -->
            <div id="companiesTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🏢 Companies Database</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCompaniesInDB">0</div>
                        <div class="stat-label">Total Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesContacted">0</div>
                        <div class="stat-label">Companies Contacted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesEngaged">0</div>
                        <div class="stat-label">Engaged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="companiesDoNotContact">0</div>
                        <div class="stat-label">Do Not Contact</div>
                    </div>
                </div>

                <div class="company-search">
                    <input type="text" id="companySearchInput" placeholder="Search companies by name, number, or PSC name..." onkeyup="searchCompanies()">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addManualCompany()">
                        + Add Manual Entry
                    </button>
                    <button class="btn btn-secondary" onclick="exportCRMData()">
                        Export Database
                    </button>
                </div>

                <div id="companiesList" style="margin-top: 30px;">
                    <!-- Companies will be displayed here -->
                </div>
            </div>

            <!-- Verify Tab -->
            <div id="verifyTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🔍 PSC Verification Against Companies House</h3>
                
                <div class="alert alert-info" style="margin-bottom: 20px;">
                    <strong>How it works:</strong> The system compares your PSC data against Companies House records. 
                    It looks for name matches and address consistency to verify accuracy.
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="verificationProgress" style="width: 0%;">
                        0%
                    </div>
                </div>

                <div id="verificationContent">
                    <p style="color: #6c757d; margin: 20px 0;">Upload data first to begin verification process.</p>
                </div>

                <div class="action-buttons" id="verifyActions" style="display: none;">
                    <button class="btn btn-success" onclick="verifyAll()">
                        <span id="verifyBtnText">Verify All Records</span>
                        <span class="loading-spinner" id="verifySpinner" style="display: none;"></span>
                    </button>
                    <button class="btn btn-warning" onclick="verifySelected()">
                        <span id="verifySelectedText">Verify Selected</span>
                        <span class="loading-spinner" id="verifySelectedSpinner" style="display: none;"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="exportVerificationReport()">
                        Export Report
                    </button>
                </div>
            </div>

            <!-- Mail Generation Tab -->
            <div id="mergeTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">📮 Mail Generation with Duplicate Protection</h3>
                
                <div id="mergeContent">
                    <p style="color: #6c757d; margin: 20px 0;">Loading...</p>
                </div>

                <div id="duplicateCheckResults" style="display: none;">
                    <!-- Duplicate check results will appear here -->
                </div>

                <div id="lettersList" style="display: none;">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateLettersAfterCheck()">
                            Generate Letters for Eligible Companies
                        </button>
                        <button class="btn btn-secondary" onclick="previewTemplate()">
                            Preview Template
                        </button>
                    </div>
                    <div id="generatedLetters" style="margin-top: 30px;"></div>
                </div>
            </div>

            <!-- Print Tab -->
            <div id="printTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">🖨️ Print Queue Management</h3>
                <div id="printContent">
                    <p style="color: #6c757d; margin: 20px 0;">No letters ready for printing.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Edit Record</h3>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="modalSaveBtn" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- API Status Indicator -->
    <div id="apiStatus" class="api-status demo" onclick="testAPIConnection()">
        Testing API Connection...
    </div>

    <script>
        // ============================================
        // CORRECTED CRM WITH COMPANIES HOUSE API
        // NO REGEX SYNTAX ERRORS
        // ============================================

        // API Configuration
        const API_CONFIG = {
            baseURL: window.location.hostname === 'localhost' 
                ? 'http://localhost:8888/.netlify/functions/companies-house'
                : '/.netlify/functions/companies-house',
            demoMode: false
        };

        // Global data storage
        let companiesDatabase = {};
        let uploadedData = [];
        let verifiedData = [];
        let lettersGenerated = [];
        let currentEditIndex = -1;
        let currentModalType = 'edit';

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatCompleteAddress(record) {
            const parts = [];
            if (record.addressLine1 && record.addressLine1.trim()) parts.push(record.addressLine1.trim());
            if (record.addressLine2 && record.addressLine2.trim()) parts.push(record.addressLine2.trim());
            if (record.city && record.city.trim()) parts.push(record.city.trim());
            if (record.county && record.county.trim()) parts.push(record.county.trim());
            if (record.postcode && record.postcode.trim()) parts.push(record.postcode.trim());
            return parts.join(', ');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabs = ['upload', 'companies', 'verify', 'merge', 'print'];
            const tabIndex = tabs.indexOf(tabName);
            document.querySelectorAll('.nav-tab')[tabIndex].classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'companies') {
                updateDashboardStats();
                displayCompanies();
            } else if (tabName === 'merge') {
                updateMailMergeTab();
            } else if (tabName === 'verify') {
                setupVerification();
            }
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (count > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }

        function generateReference() {
            const prefix = 'HD';
            const number = Math.floor(100000 + Math.random() * 900000);
            return `${prefix}/${number}`;
        }

        function proceedToVerification() {
            switchTab('verify');
        }

        // ============================================
        // API CONNECTION TESTING
        // ============================================
        
        async function checkAPIConnection() {
            try {
                const response = await fetch(API_CONFIG.baseURL);
                const data = await response.json();
                
                if (response.ok && (data.status === 'working' || data.status === 'ready')) {
                    document.getElementById('apiStatus').className = 'api-status connected';
                    document.getElementById('apiStatus').textContent = '✓ Companies House API Connected';
                    console.log('✓ Companies House API connected');
                    return true;
                }
            } catch (error) {
                console.error('API connection failed:', error);
            }
            
            document.getElementById('apiStatus').className = 'api-status error';
            document.getElementById('apiStatus').textContent = '✗ API Connection Failed';
            return false;
        }

        async function testAPIConnection() {
            document.getElementById('apiStatus').textContent = 'Testing connection...';
            await checkAPIConnection();
        }

        // ============================================
        // CRM DATABASE FUNCTIONS
        // ============================================
        
        function initializeCRMDatabase() {
            loadCRMData();
            updateDashboardStats();
            displayCompanies();
            checkAPIConnection();
        }

        function saveCRMData() {
            try {
                localStorage.setItem('ukBusinessCRM', JSON.stringify(companiesDatabase));
                console.log('CRM data saved successfully');
            } catch (error) {
                console.error('Failed to save CRM data:', error);
                alert('Warning: Failed to save data to browser storage');
            }
        }

        function loadCRMData() {
            try {
                const saved = localStorage.getItem('ukBusinessCRM');
                if (saved) {
                    companiesDatabase = JSON.parse(saved);
                    console.log(`Loaded ${Object.keys(companiesDatabase).length} companies from storage`);
                    return true;
                }
            } catch (error) {
                console.error('Failed to load CRM data:', error);
            }
            return false;
        }

        function addCompanyToCRM(recordData) {
            const companyNumber = recordData.companyNumber;
            
            if (companiesDatabase[companyNumber]) {
                console.log('Company already exists in CRM:', companyNumber);
                return false;
            }

            companiesDatabase[companyNumber] = {
                companyNumber: companyNumber,
                companyName: recordData.companyName,
                industry: recordData.industry || '',
                turnover: recordData.turnover || '',
                website: recordData.website || '',
                
                primaryPSC: {
                    pscTitle: recordData.pscTitle,
                    pscFirstName: recordData.pscFirstName,
                    pscLastName: recordData.pscLastName,
                    pscFullName: recordData.pscFullName,
                    addressLine1: recordData.addressLine1,
                    addressLine2: recordData.addressLine2,
                    city: recordData.city,
                    county: recordData.county,
                    postcode: recordData.postcode
                },
                
                otherContacts: [],
                communications: [],
                
                verificationStatus: 'pending',
                verificationDate: null,
                verificationDetails: null,
                
                status: 'new',
                reference: recordData.reference,
                addedDate: new Date().toISOString().split('T')[0],
                lastMailDate: null,
                lastContactDate: null,
                nextAction: null,
                doNotContact: false,
                selected: false,
                
                intelligence: {
                    businessNotes: '',
                    acquisitionTriggers: '',
                    lastResearched: null,
                    recentNews: []
                }
            };
            
            saveCRMData();
            return true;
        }

        function checkContactHistory(companyNumber) {
            const company = companiesDatabase[companyNumber];
            if (!company) return { canContact: true, reason: 'new_company' };
            
            if (company.doNotContact) {
                return { canContact: false, reason: 'do_not_contact' };
            }
            
            if (company.lastMailDate) {
                const daysSinceLastLetter = Math.floor(
                    (new Date() - new Date(company.lastMailDate)) / (1000 * 60 * 60 * 24)
                );
                
                if (daysSinceLastLetter < 365) {
                    return { 
                        canContact: false, 
                        reason: 'recent_contact',
                        lastContactDate: company.lastMailDate,
                        daysSince: daysSinceLastLetter
                    };
                }
            }
            
            return { canContact: true, reason: 'eligible' };
        }

        function addCommunicationRecord(companyNumber, communicationData) {
            if (!companiesDatabase[companyNumber]) {
                console.error('Company not found:', companyNumber);
                return false;
            }
            
            const communication = {
                id: `comm_${Date.now()}`,
                date: communicationData.date || new Date().toISOString().split('T')[0],
                type: communicationData.type,
                subject: communicationData.subject || '',
                notes: communicationData.notes || '',
                response: communicationData.response || null,
                responseDate: communicationData.responseDate || null
            };
            
            companiesDatabase[companyNumber].communications.push(communication);
            
            if (communication.type === 'letter' && companiesDatabase[companyNumber].status === 'new') {
                companiesDatabase[companyNumber].status = 'prospected';
                companiesDatabase[companyNumber].lastMailDate = communication.date;
                companiesDatabase[companyNumber].lastContactDate = communication.date;
            }
            
            saveCRMData();
            return communication.id;
        }

        // ============================================
        // UPLOAD PROCESSING - FIXED ADDRESS DISPLAY
        // ============================================
        
        function processUploadedData(data) {
            console.log('Processing uploaded data...');
            console.log('First row raw data:', data[0]);
            console.log('Available columns:', Object.keys(data[0] || {}));
            
            uploadedData = data.map((row, index) => {
                const record = {
                    id: index + 1,
                    companyName: row['Company Name'] || row['company_name'] || '',
                    companyNumber: row['Company Number'] || row['company_number'] || '',
                    pscTitle: row['PSC Title'] || row['Title'] || 'Mr',
                    pscFirstName: row['PSC First Name'] || row['PSC_First_Name'] || '',
                    pscLastName: row['PSC Last Name'] || row['PSC_Last_Name'] || '',
                    pscFullName: ((row['PSC First Name'] || '') + ' ' + (row['PSC Last Name'] || '')).trim(),
                    
                    // ENHANCED: Try multiple column name variations
                    addressLine1: row['PSC Address1'] || row['PSC_Address1'] || row['Address Line 1'] || row['PSC 1'] || '',
                    addressLine2: row['PSC Address2'] || row['PSC_Address2'] || row['Address Line 2'] || row['PSC 2'] || '',
                    city: row['PSC Address3'] || row['PSC_Address3'] || row['City'] || row['PSC 3'] || '',
                    county: row['PSC Address4'] || row['PSC_Address4'] || row['County'] || row['PSC 4'] || '',
                    postcode: row['PSC Postcode'] || row['PSC_Postcode'] || row['Postcode'] || '',
                    
                    reference: row['Reference'] || row['reference'] || generateReference(),
                    industry: row['Industry'] || '',
                    turnover: row['Turnover'] || '',
                    status: 'pending',
                    selected: false,
                    inDatabase: companiesDatabase[row['Company Number']] ? true : false,
                    lastContact: companiesDatabase[row['Company Number']] ? companiesDatabase[row['Company Number']].lastMailDate : null
                };
                
                // Debug logging for first record
                if (index === 0) {
                    console.log('Processed first record address:', {
                        addressLine1: record.addressLine1,
                        addressLine2: record.addressLine2,
                        city: record.city,
                        county: record.county,
                        postcode: record.postcode,
                        complete: formatCompleteAddress(record)
                    });
                }
                
                return record;
            });

            displayUploadedData();
            updateUploadStats();
            updateMailMergeTab();
        }

        // CORRECTED: Display all 5 address components
        function displayUploadedData() {
            const table = document.getElementById('dataTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th><input type="checkbox" onchange="selectAll(this)"></th>
                <th>Company Name</th>
                <th>Company Number</th>
                <th>PSC Name</th>
                <th>Complete Address</th>
                <th>CRM Status</th>
                <th>Last Contact</th>
                <th>Actions</th>
            `;
            thead.appendChild(headerRow);
            
            uploadedData.forEach((record, index) => {
                const row = document.createElement('tr');
                
                // FIXED: Show all address components
                const completeAddress = formatCompleteAddress(record);
                
                let crmStatus = 'New';
                let statusClass = 'status-new';
                if (record.inDatabase) {
                    const company = companiesDatabase[record.companyNumber];
                    crmStatus = company.status;
                    statusClass = `status-${company.status}`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" ${record.selected ? 'checked' : ''} onchange="toggleSelection(${index})"></td>
                    <td>${record.companyName}</td>
                    <td>${record.companyNumber}</td>
                    <td>${record.pscTitle} ${record.pscFullName}</td>
                    <td style="max-width: 300px; word-wrap: break-word;">
                        <div>${completeAddress}</div>
                        <small style="color: #6c757d; display: block; margin-top: 3px;">
                            1:"${record.addressLine1}" | 2:"${record.addressLine2}" | 
                            3:"${record.city}" | 4:"${record.county}" | PC:"${record.postcode}"
                        </small>
                    </td>
                    <td><span class="status-badge ${statusClass}">${crmStatus}</span></td>
                    <td>${record.lastContact || 'Never'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editRecord(${index})" style="padding: 5px 10px; font-size: 0.85rem;">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('dataPreview').style.display = 'block';
        }

        function updateUploadStats() {
            const newCompanies = uploadedData.filter(r => !r.inDatabase).length;
            const duplicateCompanies = uploadedData.filter(r => r.inDatabase).length;
            
            document.getElementById('totalRecords').textContent = uploadedData.length;
            document.getElementById('uniqueCompanies').textContent = 
                new Set(uploadedData.map(r => r.companyNumber)).size;
            document.getElementById('newCompanies').textContent = newCompanies;
            document.getElementById('duplicateCompanies').textContent = duplicateCompanies;
        }

        function addToCRMDatabase() {
            const newCompanies = uploadedData.filter(r => !r.inDatabase);
            
            if (newCompanies.length === 0) {
                alert('No new companies to add - all are already in the database');
                return;
            }
            
            let addedCount = 0;
            newCompanies.forEach(record => {
                if (addCompanyToCRM(record)) {
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                alert(`Successfully added ${addedCount} new companies to the database`);
                updateDashboardStats();
                displayCompanies();
                
                // Refresh the upload view
                processUploadedData(uploadedData.map(r => ({
                    'Company Name': r.companyName,
                    'Company Number': r.companyNumber,
                    'PSC Title': r.pscTitle,
                    'PSC First Name': r.pscFirstName,
                    'PSC Last Name': r.pscLastName,
                    'PSC Address1': r.addressLine1,
                    'PSC Address2': r.addressLine2,
                    'PSC Address3': r.city,
                    'PSC Address4': r.county,
                    'PSC Postcode': r.postcode,
                    'Reference': r.reference,
                    'Industry': r.industry,
                    'Turnover': r.turnover
                })));
            }
        }

        // ============================================
        // COMPANIES DATABASE DISPLAY
        // ============================================
        
        function displayCompanies(searchTerm = '') {
            const companiesList = document.getElementById('companiesList');
            const companies = Object.values(companiesDatabase);
            
            let filteredCompanies = companies;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredCompanies = companies.filter(company => 
                    company.companyName.toLowerCase().includes(term) ||
                    company.companyNumber.toLowerCase().includes(term) ||
                    company.primaryPSC.pscFullName.toLowerCase().includes(term)
                );
            }
            
            if (filteredCompanies.length === 0) {
                companiesList.innerHTML = searchTerm ? 
                    '<p>No companies found matching your search.</p>' :
                    '<p>No companies in database yet. Upload data to get started.</p>';
                return;
            }
            
            companiesList.innerHTML = filteredCompanies
                .sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate))
                .map(company => `
                    <div class="company-card">
                        <div class="company-header">
                            <div>
                                <div class="company-title">${company.companyName}</div>
                                <div class="company-subtitle">${company.companyNumber} | ${company.primaryPSC.pscFullName}</div>
                            </div>
                            <div>
                                <span class="status-badge status-${company.status}">${company.status}</span>
                                <span class="status-badge status-${company.verificationStatus || 'pending'}">${company.verificationStatus || 'pending'}</span>
                            </div>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <strong>Complete Address:</strong> ${formatCompleteAddress(company.primaryPSC)}<br>
                            ${company.website ? `<strong>Website:</strong> <a href="${company.website}" target="_blank">${company.website}</a><br>` : ''}
                            <strong>Reference:</strong> ${company.reference}
                        </div>
                        
                        <div class="last-contact">
                            Last Contact: ${company.lastContactDate || 'Never'} | 
                            Communications: ${company.communications.length} | 
                            Verified: ${company.verificationDate || 'No'} | 
                            Added: ${company.addedDate}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="viewCompanyDetails('${company.companyNumber}')">
                                View Details
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editCompanyRecord('${company.companyNumber}')">
                                Edit
                            </button>
                            ${(!company.verificationStatus || company.verificationStatus === 'pending') ? `
                                <button class="btn btn-sm btn-warning" onclick="verifyIndividual('${company.companyNumber}')">
                                    Verify PSC
                                </button>
                            ` : ''}
                            ${!company.doNotContact && (!company.lastMailDate || daysSinceContact(company.lastMailDate) > 365) ? `
                                <button class="btn btn-sm btn-success" onclick="generateSingleLetter('${company.companyNumber}')">
                                    Send Letter
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
        }

        function searchCompanies() {
            const searchTerm = document.getElementById('companySearchInput').value;
            displayCompanies(searchTerm);
        }

        function updateDashboardStats() {
            const companies = Object.values(companiesDatabase);
            const total = companies.length;
            const contacted = companies.filter(c => c.status === 'prospected' || c.status === 'contacted' || c.status === 'engaged').length;
            const engaged = companies.filter(c => c.status === 'engaged').length;
            const doNotContact = companies.filter(c => c.doNotContact).length;
            
            document.getElementById('totalCompaniesInDB').textContent = total;
            document.getElementById('companiesContacted').textContent = contacted;
            document.getElementById('companiesEngaged').textContent = engaged;
            document.getElementById('companiesDoNotContact').textContent = doNotContact;
            
            updateBadge('companiesBadge', total);
        }

        function daysSinceContact(dateString) {
            if (!dateString) return 999;
            return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
        }

        // ============================================
        // SIMPLIFIED PSC VERIFICATION
        // ============================================
        
        // REPLACE the verifyIndividual function with this improved version

async function verifyIndividual(companyNumber) {
    const company = companiesDatabase[companyNumber];
    if (!company) return false;

    try {
        console.log(`Verifying company: ${companyNumber}`);
        
        const response = await fetch(`${API_CONFIG.baseURL}/psc/${companyNumber}`);
        
        if (!response.ok) {
            const errorData = await response.json();
            company.verificationStatus = 'error';
            company.verificationDetails = {
                error: errorData.error || 'Company not found',
                date: new Date().toISOString().split('T')[0]
            };
            
            updateVerificationDisplay(companyNumber);
            saveCRMData();
            return false;
        }

        const data = await response.json();
        
        if (!data.items || data.items.length === 0) {
            company.verificationStatus = 'error';
            company.verificationDetails = {
                error: 'No PSC data found',
                date: new Date().toISOString().split('T')[0]
            };
            
            updateVerificationDisplay(companyNumber);
            saveCRMData();
            return false;
        }

        // IMPROVED verification logic with better name matching
        const yourPostcode = company.primaryPSC.postcode.toUpperCase().replace(/\s/g, '');
        const yourFirstName = company.primaryPSC.pscFirstName.toUpperCase().replace(/[^A-Z]/g, '');
        const yourLastName = company.primaryPSC.pscLastName.toUpperCase().replace(/[^A-Z]/g, '');
        
        let bestMatch = null;
        let bestScore = 0;
        
        console.log(`Looking for: "${yourFirstName}" "${yourLastName}" at postcode: "${yourPostcode}"`);

        for (const psc of data.items) {
            const chPostcode = (psc.address?.postal_code || '').toUpperCase().replace(/\s/g, '');
            const pscName = (psc.name || '').toUpperCase().replace(/[^A-Z\s]/g, '');
            
            console.log(`Checking PSC: "${pscName}" at postcode: "${chPostcode}"`);
            
            let score = 0;
            
            // Score for name matches
            if (pscName.includes(yourLastName)) score += 50;
            if (pscName.includes(yourFirstName)) score += 30;
            
            // Score for postcode match
            if (chPostcode === yourPostcode) score += 20;
            
            console.log(`Score for ${pscName}: ${score} (LastName:${pscName.includes(yourLastName)} FirstName:${pscName.includes(yourFirstName)} Postcode:${chPostcode === yourPostcode})`);
            
            if (score > bestScore) {
                bestScore = score;
                bestMatch = psc;
            }
        }

        console.log(`Best match score: ${bestScore}`);

        if (bestMatch) {
            // FIXED: More nuanced verification logic
            if (bestScore >= 70) {
                // Both name and postcode match
                company.verificationStatus = 'verified';
            } else if (bestScore >= 50) {
                // Name matches but address might differ
                company.verificationStatus = 'mismatch';
            } else {
                // Low confidence match
                company.verificationStatus = 'error';
                company.verificationDetails = {
                    error: 'Low confidence match',
                    date: new Date().toISOString().split('T')[0]
                };
                updateVerificationDisplay(companyNumber);
                saveCRMData();
                return false;
            }
            
            company.verificationDetails = {
                date: new Date().toISOString().split('T')[0],
                matchedPSC: bestMatch,
                verified: company.verificationStatus === 'verified',
                score: bestScore
            };
        } else {
            company.verificationStatus = 'error';
            company.verificationDetails = {
                error: 'No matching PSC found',
                date: new Date().toISOString().split('T')[0]
            };
        }

        company.verificationDate = new Date().toISOString().split('T')[0];
        updateVerificationDisplay(companyNumber);
        saveCRMData();
        
        return true;

    } catch (error) {
        console.error(`Verification failed for ${companyNumber}:`, error);
        
        company.verificationStatus = 'error';
        company.verificationDetails = {
            error: error.message,
            date: new Date().toISOString().split('T')[0]
        };
        
        updateVerificationDisplay(companyNumber);
        saveCRMData();
        return false;
    }
}

        function updateVerificationDisplay(companyNumber) {
            const company = companiesDatabase[companyNumber];
            const resultDiv = document.getElementById(`verifyResult_${companyNumber}`);
            
            if (!resultDiv) return;
            
            let html = '';
            
            switch (company.verificationStatus) {
                case 'verified':
                    html = `
                        <div class="verification-result verified">
                            <strong>✓ Verified</strong> - PSC name and postcode match
                        </div>
                    `;
                    break;
                    
                case 'mismatch':
                    const details = company.verificationDetails;
                    const yourAddress = formatCompleteAddress(company.primaryPSC);
                    
                    html = `
                        <div class="verification-result mismatch">
                            <strong>⚠️ Name Match, Address Different</strong><br>
                            <div style="margin: 8px 0; font-size: 0.85rem;">
                                <strong>Your Address:</strong> ${yourAddress}<br>
                                <strong>Companies House:</strong> ${details.matchedPSC.address?.postal_code || 'Unknown'}
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="updateWithCHData('${companyNumber}')" style="margin-top: 5px;">
                                Update Address
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'error':
                    html = `
                        <div class="verification-result error">
                            <strong>✗ Error:</strong> ${company.verificationDetails.error}
                        </div>
                    `;
                    break;
                    
                default:
                    html = `<div>Verifying...</div>`;
            }
            
            resultDiv.innerHTML = html;
        }

        function updateWithCHData(companyNumber) {
            const company = companiesDatabase[companyNumber];
            const chPSC = company.verificationDetails.matchedPSC;
            
            if (!chPSC || !chPSC.address) return;
            
            // Simple update with Companies House address
            if (chPSC.address.postal_code) company.primaryPSC.postcode = chPSC.address.postal_code;
            if (chPSC.address.locality) company.primaryPSC.city = chPSC.address.locality;
            if (chPSC.address.region) company.primaryPSC.county = chPSC.address.region;
            
            company.verificationStatus = 'verified';
            
            saveCRMData();
            updateVerificationDisplay(companyNumber);
            updateDashboardStats();
            
            alert('Address updated with Companies House data');
        }

        // ============================================
        // VERIFICATION TAB SETUP
        // ============================================
        
        function setupVerification() {
            const companies = Object.values(companiesDatabase);
            
            companies.forEach(company => {
                if (!company.verificationStatus) {
                    company.verificationStatus = 'pending';
                }
                if (company.selected === undefined) {
                    company.selected = false;
                }
            });
            saveCRMData();
            
            const pendingCount = companies.filter(c => c.verificationStatus === 'pending').length;
            const verifiedCount = companies.filter(c => c.verificationStatus === 'verified').length;
            const mismatchCount = companies.filter(c => c.verificationStatus === 'mismatch').length;
            
            if (companies.length === 0) {
                document.getElementById('verificationContent').innerHTML = `
                    <p style="color: #6c757d; margin: 20px 0;">No companies in database. Please add companies first.</p>
                `;
                return;
            }
            
            document.getElementById('verificationContent').innerHTML = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${companies.length}</div>
                        <div class="stat-label">Total Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${verifiedCount}</div>
                        <div class="stat-label">Verified</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${mismatchCount}</div>
                        <div class="stat-label">Mismatches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${pendingCount}</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="selectAllVerify(this)"></th>
                                <th>Company</th>
                                <th>PSC Name</th>
                                <th>Complete Address</th>
                                <th>Verification Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${companies.map(company => `
                                <tr>
                                    <td><input type="checkbox" ${company.selected ? 'checked' : ''} onchange="toggleCompanySelection('${company.companyNumber}')"></td>
                                    <td>
                                        <strong>${company.companyName}</strong><br>
                                        <small>${company.companyNumber}</small>
                                    </td>
                                    <td>${company.primaryPSC.pscTitle} ${company.primaryPSC.pscFullName}</td>
                                    <td style="max-width: 250px; word-wrap: break-word;">
                                        ${formatCompleteAddress(company.primaryPSC)}
                                    </td>
                                    <td>
                                        <span class="status-badge status-${company.verificationStatus}">${company.verificationStatus}</span>
                                        <div id="verifyResult_${company.companyNumber}"></div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="verifyIndividual('${company.companyNumber}')">
                                            Verify
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('verifyActions').style.display = 'flex';
            updateBadge('verifyBadge', pendingCount);
            
            companies.forEach(company => {
                if (company.verificationStatus && company.verificationStatus !== 'pending') {
                    updateVerificationDisplay(company.companyNumber);
                }
            });
        }

        function toggleCompanySelection(companyNumber) {
            if (companiesDatabase[companyNumber]) {
                companiesDatabase[companyNumber].selected = !companiesDatabase[companyNumber].selected;
                saveCRMData();
                console.log(`Company ${companyNumber} selected:`, companiesDatabase[companyNumber].selected);
            }
        }

        function selectAllVerify(checkbox) {
            Object.values(companiesDatabase).forEach(company => {
                company.selected = checkbox.checked;
            });
            saveCRMData();
            console.log('Select all:', checkbox.checked);
        }

        async function verifyAll() {
            const companies = Object.values(companiesDatabase);
            const pendingCompanies = companies.filter(c => c.verificationStatus === 'pending');
            
            if (pendingCompanies.length === 0) {
                alert('No companies need verification.');
                return;
            }
            
            const button = document.getElementById('verifyBtnText');
            const spinner = document.getElementById('verifySpinner');
            
            button.textContent = 'Verifying...';
            spinner.style.display = 'inline-block';
            
            let completed = 0;
            for (const company of pendingCompanies) {
                await verifyIndividual(company.companyNumber);
                completed++;
                
                const progress = (completed / pendingCompanies.length) * 100;
                document.getElementById('verificationProgress').style.width = progress + '%';
                document.getElementById('verificationProgress').textContent = Math.round(progress) + '%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            button.textContent = 'Verify All Records';
            spinner.style.display = 'none';
            
            alert(`Verification complete! Processed ${pendingCompanies.length} companies.`);
            updateDashboardStats();
            updateMailMergeTab();
            setupVerification();
        }

        async function verifySelected() {
            const companies = Object.values(companiesDatabase);
            const selectedCompanies = companies.filter(c => c.selected && c.verificationStatus === 'pending');
            
            if (selectedCompanies.length === 0) {
                const anySelected = companies.filter(c => c.selected);
                if (anySelected.length === 0) {
                    alert('Please select companies to verify by checking the checkboxes.');
                } else {
                    alert('Selected companies have already been verified.');
                }
                return;
            }
            
            const button = document.getElementById('verifySelectedText');
            const spinner = document.getElementById('verifySelectedSpinner');
            
            button.textContent = `Verifying ${selectedCompanies.length}...`;
            spinner.style.display = 'inline-block';
            
            let completed = 0;
            for (const company of selectedCompanies) {
                await verifyIndividual(company.companyNumber);
                completed++;
                
                const progress = (completed / selectedCompanies.length) * 100;
                document.getElementById('verificationProgress').style.width = progress + '%';
                document.getElementById('verificationProgress').textContent = Math.round(progress) + '%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            button.textContent = 'Verify Selected';
            spinner.style.display = 'none';
            
            alert(`Verification complete! Processed ${selectedCompanies.length} selected companies.`);
            updateDashboardStats();
            updateMailMergeTab();
            setupVerification();
        }

        // ============================================
        // MAIL MERGE
        // ============================================
        
        function updateMailMergeTab() {
            const companies = Object.values(companiesDatabase);
            const eligibleCount = companies.filter(c => {
                const check = checkContactHistory(c.companyNumber);
                return check.canContact;
            }).length;
            
            const recentContactCount = companies.filter(c => {
                const check = checkContactHistory(c.companyNumber);
                return !check.canContact && check.reason === 'recent_contact';
            }).length;
            
            const mergeContent = document.getElementById('mergeContent');
            
            if (companies.length === 0) {
                mergeContent.innerHTML = '<p style="color: #6c757d; margin: 20px 0;">No companies in database. Please upload data first.</p>';
                return;
            }
            
            mergeContent.innerHTML = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${companies.length}</div>
                        <div class="stat-label">Total Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${eligibleCount}</div>
                        <div class="stat-label">Eligible for Contact</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${recentContactCount}</div>
                        <div class="stat-label">Recently Contacted</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="runDuplicateCheck()">
                        Check Eligible Companies
                    </button>
                </div>
            `;
        }

        function runDuplicateCheck() {
            const companies = Object.values(companiesDatabase);
            const eligibleRecords = [];
            const blockedRecords = [];
            
            companies.forEach(company => {
                const check = checkContactHistory(company.companyNumber);
                
                if (check.canContact) {
                    eligibleRecords.push(company);
                } else {
                    blockedRecords.push({
                        ...company,
                        blockReason: check.reason,
                        lastContact: check.lastContactDate,
                        daysSince: check.daysSince
                    });
                }
            });
            
            displayDuplicateCheckResults(eligibleRecords, blockedRecords);
        }

        function displayDuplicateCheckResults(eligible, blocked) {
            const resultsDiv = document.getElementById('duplicateCheckResults');
            resultsDiv.style.display = 'block';
            
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h4>✅ Ready to Contact: ${eligible.length} companies</h4>
                    <p>These companies haven't been contacted in the last 12 months and are eligible for letters.</p>
                </div>
                
                ${blocked.length > 0 ? `
                    <div class="alert alert-warning">
                        <h4>⚠️ Recently Contacted: ${blocked.length} companies</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>PSC</th>
                                        <th>Last Contact</th>
                                        <th>Days Ago</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${blocked.map(company => `
                                        <tr>
                                            <td>${company.companyName}</td>
                                            <td>${company.primaryPSC.pscFullName}</td>
                                            <td>${company.lastContact || 'N/A'}</td>
                                            <td>${company.daysSince || 'N/A'}</td>
                                            <td>${company.blockReason === 'recent_contact' ? 'Too Recent' : 'Do Not Contact'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${eligible.length > 0 ? `
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="generateLettersForEligible()">
                            Generate ${eligible.length} Letters
                        </button>
                        <button class="btn btn-secondary" onclick="previewTemplate()">
                            Preview Template
                        </button>
                    </div>
                ` : ''}
            `;
            
            window.eligibleCompanies = eligible;
        }

        function generateLettersForEligible() {
            if (!window.eligibleCompanies || window.eligibleCompanies.length === 0) {
                alert('No eligible companies found. Run duplicate check first.');
                return;
            }
            
            lettersGenerated = window.eligibleCompanies.map(company => {
                addCommunicationRecord(company.companyNumber, {
                    type: 'letter',
                    subject: 'Initial Acquisition Inquiry',
                    notes: 'Template: standard_acquisition'
                });
                
                return {
                    ...company,
                    letterContent: generateLetterContent(company),
                    envelopeContent: generateEnvelopeContent(company)
                };
            });
            
            updateBadge('printBadge', lettersGenerated.length);
            updateDashboardStats();
            
            alert(`Generated ${lettersGenerated.length} letters successfully! Communication records have been logged.`);
        }

        function generateLetterContent(company) {
            const today = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            const psc = company.primaryPSC;
            
            return `
                <div class="letter-preview">
                    <div style="text-decoration: underline; margin-bottom: 20px;">[STRICTLY PRIVATE AND CONFIDENTIAL]</div>
                    <div style="text-align: right;">London Office</div>
                    
                    <div style="margin: 20px 0;">
                        ${psc.pscTitle} ${psc.pscFirstName} ${psc.pscLastName}<br>
                        ${psc.addressLine1}<br>
                        ${psc.addressLine2 ? psc.addressLine2 + '<br>' : ''}
                        ${psc.city}<br>
                        ${psc.county ? psc.county + '<br>' : ''}
                        ${psc.postcode}
                    </div>
                    
                    <div style="margin: 20px 0;">${today}</div>
                    
                    <div>Dear ${psc.pscTitle} ${psc.pscLastName},</div>
                    
                    <div style="margin: 20px 0;">
                        <strong>Ref: ${company.reference}</strong>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: justify;">
                        <p style="margin-bottom: 15px;">I am writing to you on a confidential basis following specific acquisition research work we have recently carried out.</p>
                        
                        <p style="margin-bottom: 15px;">It would appear that ${company.companyName} falls within the acquisition brief of a particular acquirer client of ours, thus I am writing to establish if you are interested in having an initial discussion regarding the possible sale of your business.</p>
                        
                        <p style="margin-bottom: 15px;">As corporate intermediaries established for more than 40 years, we carry out acquisition work for our public and private company and private equity acquirer clients who have funds totalling more than £5bn to acquire businesses on a strictly private and confidential basis. We are a discreet firm and do not advertise to the public.</p>
                        
                        <p style="margin-bottom: 15px;">The fees for our services are paid by our client, the acquirer, and we would make no charge to you, the vendor. We usually deal with vendor businesses which have not formally announced they are for sale, are not being actively marketed for sale and are seeking a discreet sale.</p>
                        
                        <p style="margin-bottom: 15px;">If you are interested in such a possibility, I should welcome the opportunity of having an exploratory discussion with you at a time that suits you. I can assure you that the matter would be dealt with on a strictly confidential basis and would receive my immediate attention.</p>
                        
                        <p style="margin-bottom: 15px;">I hope to hear from you at an early date and can be contacted directly on 0203 633 4829 or by email at: rudi@mgbco.co.uk.</p>
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <p>Yours sincerely,</p>
                        <br>
                        <br>
                        <p>Rudi Prenzlin</p>
                        <p><u>Acquisitions Specialist</u></p>
                    </div>
                </div>
            `;
        }

        function generateEnvelopeContent(company) {
            const psc = company.primaryPSC;
            
            return `
                <div style="width: 400px; height: 200px; border: 2px solid #ccc; padding: 30px; display: flex; align-items: center; justify-content: center; font-family: 'Times New Roman', serif;">
                    <div style="text-align: center; line-height: 1.8;">
                        ${psc.pscTitle} ${psc.pscFirstName} ${psc.pscLastName}<br>
                        ${psc.addressLine1}<br>
                        ${psc.addressLine2 ? psc.addressLine2 + '<br>' : ''}
                        ${psc.city}<br>
                        ${psc.county ? psc.county + '<br>' : ''}
                        ${psc.postcode}
                    </div>
                </div>
            `;
        }

        function exportVerificationReport() {
            const companies = Object.values(companiesDatabase);
            
            const report = companies.map(company => ({
                'Company Name': company.companyName,
                'Company Number': company.companyNumber,
                'PSC Title': company.primaryPSC.pscTitle,
                'PSC First Name': company.primaryPSC.pscFirstName,
                'PSC Last Name': company.primaryPSC.pscLastName,
                'Complete Address': formatCompleteAddress(company.primaryPSC),
                'Verification Status': company.verificationStatus || 'pending',
                'Verification Date': company.verificationDate || '',
                'Status': company.status,
                'Reference': company.reference,
                'Communications': company.communications.length
            }));
            
            const ws = XLSX.utils.json_to_sheet(report);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Verification Report');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `verification_report_${date}.xlsx`);
        }

        // ============================================
        // FILE UPLOAD HANDLER
        // ============================================
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        processUploadedData(jsonData);
                        
                        document.getElementById('uploadSection').classList.add('has-file');
                        document.getElementById('fileInfo').style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('sampleDataSection').style.display = 'none';
                    } catch (error) {
                        alert('Error reading file. Please ensure it\'s a valid Excel file.');
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // ============================================
        // SAMPLE DATA
        // ============================================
        
        function loadSampleData() {
            const sampleData = [
                {
                    'Company Name': 'Davies Crane Hire Holdings Limited',
                    'Company Number': '08234567',
                    'PSC Title': 'Mr',
                    'PSC First Name': 'Malcolm',
                    'PSC Last Name': 'Davies',
                    'PSC Address1': 'Pensarn Works',
                    'PSC Address2': 'Pensarn',
                    'PSC Address3': 'Carmarthen',
                    'PSC Address4': 'Dyfed',
                    'PSC Postcode': 'SA31 2NG',
                    'Reference': 'HD/150902',
                    'Industry': 'Construction',
                    'Turnover': '£25m'
                },
                {
                    'Company Name': 'Smith Engineering Services Ltd',
                    'Company Number': '09876543',
                    'PSC Title': 'Mr',
                    'PSC First Name': 'James',
                    'PSC Last Name': 'Smith',
                    'PSC Address1': '45 Industrial Estate',
                    'PSC Address2': 'Westfield Road',
                    'PSC Address3': 'Birmingham',
                    'PSC Address4': 'West Midlands',
                    'PSC Postcode': 'B15 3TH',
                    'Reference': 'HD/150903',
                    'Industry': 'Engineering',
                    'Turnover': '£15m'
                },
                {
                    'Company Name': 'Thompson Manufacturing Group',
                    'Company Number': '07654321',
                    'PSC Title': 'Ms',
                    'PSC First Name': 'Sarah',
                    'PSC Last Name': 'Thompson',
                    'PSC Address1': 'Unit 12, Valley Business Park',
                    'PSC Address2': '',
                    'PSC Address3': 'Leeds',
                    'PSC Address4': 'West Yorkshire',
                    'PSC Postcode': 'LS12 5BH',
                    'Reference': 'HD/150904',
                    'Industry': 'Manufacturing',
                    'Turnover': '£40m'
                }
            ];

            processUploadedData(sampleData);
            
            document.getElementById('uploadSection').classList.add('has-file');
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = 'Sample Data (3 records)';
            document.getElementById('sampleDataSection').style.display = 'none';
        }

        // ============================================
        // STUB FUNCTIONS FOR FUTURE PHASES
        // ============================================
        
        function selectAll(checkbox) {
            uploadedData.forEach(record => record.selected = checkbox.checked);
            displayUploadedData();
        }

        function toggleSelection(index) {
            uploadedData[index].selected = !uploadedData[index].selected;
        }

        function editRecord(index) {
            alert('Edit functionality will be enhanced in future phases');
        }

        function addManualCompany() {
            alert('Manual company entry will be implemented in future phases');
        }

        function exportCRMData() {
            const companies = Object.values(companiesDatabase);
            if (companies.length === 0) {
                alert('No data to export');
                return;
            }
            
            const exportData = companies.map(company => ({
                'Company Name': company.companyName,
                'Company Number': company.companyNumber,
                'PSC Title': company.primaryPSC.pscTitle,
                'PSC First Name': company.primaryPSC.pscFirstName,
                'PSC Last Name': company.primaryPSC.pscLastName,
                'Complete Address': formatCompleteAddress(company.primaryPSC),
                'Status': company.status,
                'Verification Status': company.verificationStatus || 'pending',
                'Reference': company.reference,
                'Added Date': company.addedDate,
                'Last Mail Date': company.lastMailDate || '',
                'Communications Count': company.communications.length,
                'Do Not Contact': company.doNotContact ? 'Yes' : 'No'
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'CRM Database');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `crm_database_${date}.xlsx`);
        }

        function viewCompanyDetails(companyNumber) {
            alert(`Company details view will be implemented in future phases`);
        }

        function editCompanyRecord(companyNumber) {
            alert(`Company edit functionality will be implemented in future phases`);
        }

        function generateSingleLetter(companyNumber) {
            alert(`Single letter generation will be implemented in future phases`);
        }

        function previewTemplate() {
            alert('Template preview functionality unchanged from original');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            console.log('UK Business Outreach CRM System - Fully Corrected Version Loaded');
            initializeCRMDatabase();
        });
    </script>
</body>
</html>

